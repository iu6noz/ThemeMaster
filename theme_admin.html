
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Bootstrap CMS</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<style>
    .navbar-nav.ml-auto {
        display: flex;
        align-items: center;

    }
	.navbar{
		margin-bottom: 30px;
	}
    .profile-img {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-right: 8px;
    }
	
	#main-component{
		border: 1px solid #ccc;
		border-radius: 20px;
		padding: 15px;
		-webkit-box-shadow: 0px 0px 68px 4px rgba(179,179,179,0.78);
		-moz-box-shadow: 0px 0px 68px 4px rgba(179,179,179,0.78);
		box-shadow: 0px 0px 68px 4px rgba(179,179,179,0.78);
	}
	#main-component h1{
		font-size: 20px;
		line-height: 1;
		text-align: center;
	}
	
	#my-button{
		margin-bottom: 10px;
		margin-top: 10px;
	}
	
	#accordion .card-header {
		padding: 0.25rem 0.25rem;
		margin-bottom: 0;
		background-color: rgb(0 123 255);
		border-bottom: 1px solid rgb(0 0 0 / 17%);
		color: #fff;
	}
	
	#accordion .card-header .fas{
		margin: 0 5px;
		font-size: 10px;
	}
	
	#accordion .btn-link {
		font-weight: 600;
		color: #fff;
		text-decoration: none;
		text-transform: uppercase;
		font-size: 12px;
	}
	
	.list-group-item{
		font-size: 12px;
		line-height: 1;
		font-weight: 600;
		padding: 10px 15px 10px 30px;
	}
	
	.add-button, .delete-button, .edit-button{
	    font-size: 12px;
	}
	
	.fa-plus, .fa-edit, .fa-times, .fa-image{
	    z-index: 999;
		cursor: pointer;
	}
	
	.sub-theme-image-preview{
	    width: 14x;
    height: 14px;
    font-size: 14px;
	}
	
	.fa-image:hover{
cursor: pointer;
  animation: none;
  transition: none;
	}
	
	.added-form-group .delete-icon-in-edit{
		float: right;
		cursor: pointer;
	}
	
	.added-form-group:nth-child(even) {
  background-color: #f2f2f2;
}

.added-form-group:nth-child(odd) {
  background-color: #fff;
}

.added-form-group{
	border-bottom: 1px solid #000;
}

.modal-body{
    padding: 0px;
}

.form-group {
    padding: 15px;
	margin-bottom: 0;
}

.theme-image-preview-container{
width: 500px;

}
</style>
</head>
<body>
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
	  <a class="navbar-brand pointer-events-none" href="#">
	  </a>
	  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	  </button>
	  <div class="collapse navbar-collapse" id="navbarNav">
		<ul class="navbar-nav mr-auto">
		  <li class="nav-item active">
			<a class="nav-link" href="#">CMS<span class="sr-only">(current)</span></a>
		  </li>
		</ul>
		<ul class="navbar-nav">
		  <li class="nav-item">
			<a class="nav-link" id="user-login" href="#">
			  User Login
			</a>
		  </li>
		</ul>
	  </div>
	</nav>


	<div class="container" id="main-component">
		<div class="row">
			<div class="col-md-5 left-column">
				<div class="row">
					<div class="col-12">
						<h1>Temalar - Karakterler</h1>
					</div>
				</div>
				<div class="row">
					<div class="col-12">
						<button id="my-button" class="btn btn-primary">Tema Ekle</button>
					</div>
				</div>
				<div class="row">
					<div class="col-12">
						<div id="accordion">
						
						</div> 
					</div>
				</div>
			</div>
		
			<div class="col-md-7 right-column">		
				<button type="button" class="add-button btn btn-primary">
				  <i class="fas fa-plus"></i> Masal Ekle
				</button>

				<button type="button" class="edit-button btn btn-warning">
				  <i class="fas fa-edit"></i> Masal Düzenle
				</button>

				<button type="button" class="delete-button btn btn-danger">
				  <i class="fas fa-trash"></i> Masal Sil
				</button>
				<div id="content-table">				
					<table class="table">
					  <thead>
						<tr>
						  <th></th>
						  <th>Masal Adı</th>
						  <th>Yaş Aralığı</th>
						</tr>
					  </thead>
					  <tbody>
						<tr>
						  <td></td>
						  <td></td>
						  <td></td>
						</tr>
						<tr>
						  <td></td>
						  <td></td>
						  <td></td>
						</tr>
						<!-- Add more rows as needed -->
					  </tbody>
					</table>
				</div>		
			</div>
		</div>

	</div>
	
	<!-- Add a loader element to your HTML code -->
	<div id="loader" class="d-none">
	  <div class="d-flex justify-content-center">
		<div class="spinner-border" role="status">
		  <span class="visually-hidden">Loading...</span>
		</div>
	  </div>
	</div>
	
	<!-- The modal -->
	<div id="myModal" class="modal" data-backdrop="static" data-keyboard="false">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<h4 class="modal-title">Masallar</h4>
			<button type="button" class="close" data-dismiss="modal">&times;</button>
		  </div>
		  <div class="modal-body">
			<div id="input-container">
			  <div class="form-group none-remove-group">
				<label for="nameInput">Masal Adı:</label>
				<input type="text" class="form-control" id="nameInput">
			  </div>
			  <div class="form-group none-remove-group">
				<label for="typeInput">Yaş Aralığı:</label>
				<select class="form-control" id="typeInput">
				  <option value="0">3-5 Yaş Aralığı</option>
				  <option value="1">6-8 Yaş Aralığı</option>
				  <option value="2">9-12 Yaş Aralığı</option>
				</select>
			  </div>
			</div>
		  </div>
		  <div class="modal-footer first-modai-footer">

		  </div>

		  <div class="modal-footer">
			<button type="button" class="btn btn-success" id="saveButton">Masalı Kaydet</button>
			<button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
		  </div>
		</div>
	  </div>
	</div>


  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

	  <script>
function delay(callback) {
	setTimeout(callback, 1000); // 1000 milliseconds = 1 second
}

// Define a function to show/hide the loader
function toggleLoader(show) {
  if (show) {
    $('#loader').removeClass('d-none');
  } else {
    $('#loader').addClass('d-none');
  }
}

$(document).ready(function() {

  $('#audio-file-input').change(function() {
    // Get the selected file
    var file = $(this).prop('files')[0];
    
    // Set the audio source to the selected file
    $('#audio-source').prop('src', URL.createObjectURL(file));
    
    // Load the audio and play it
    $('#audio-preview')[0].load();
    $('#audio-preview')[0].play();
  });
	loadThemes();
	
	var editButtonElements = $('.edit-button');
	var deleteButtonElements = $('.delete-button');
	editButtonElements.prop('disabled', true);
	deleteButtonElements.prop('disabled', true);
	
	var addButtonElements = $('.add-button');
	if (!addButtonElements.attr('id')) {
	// If the element doesn't have an ID, disable it
		addButtonElements.prop('disabled', true);
	}
	
	// Get the modal element
	var modal = $("#myModal");
	// Get the input fields and button inside the modal
	var nameInput = $("#nameInput");
	var typeInput = $("#typeInput");

	$(document).on('click', '.edit-button', function() {
										
	  // Get the selected content ID	
		  var contentId = $('input[name="content-radio"]:checked').val();
		  $('#saveButton').attr('data-content-id', contentId)
		  // Make an AJAX request to get the content data
		  $.ajax({
			url: 'http://16.171.13.68:8080/content/' + contentId,
			type: 'GET',
			dataType: 'json',
			beforeSend: function() {
				toggleLoader(true); // Show the loader before the request is sent
			},
			success: function(content) {
					$('#input-container').empty();
					$('.first-modai-footer').empty();
					$('#input-container').append('<div class="form-group none-remove-group" contentid-value="'+contentId+'">'+
															'<label for="nameInput">Masal Adı:</label>'+
															'<input type="text" class="form-control" id="nameInput">'+
															'</div>'+
															'<div class="form-group none-remove-group">'+
															'<label for="typeInput">Yaş Aralığı:</label>'+
															'<select class="form-control" id="typeInput">'+
															'<option value="0">3-5 Yaş Aralığı</option>'+
															'<option value="1">6-8 Yaş Aralığı</option>'+
															'<option value="2">9-12 Yaş Aralığı</option>'+
															'</div>'+
															'</select>')														
					$('.first-modai-footer').append('<button type="button" class="btn btn-primary" id="addContentButtoninEdit">Bölüm Ekle</button>')	
				 
				// Set the name and type fields in the modal
				$('#nameInput').val(content.name);			  
				var typeSelect = $('#typeInput');
				var typeOptions = typeSelect.children('option');
				var typeValue = content.type;
				typeOptions.prop('selected', false);
				for (var i = 0; i < typeOptions.length; i++) {
					if (typeOptions.eq(i).val() == typeValue) {
						typeOptions.eq(i).prop('selected', true);
						break;
					}
				}			  
				var subthemeID = content.subThemeId;
			  
				// Make an AJAX request to get the content parts data
				$.ajax({
					url: 'http://16.171.13.68:8080/content-part/by-content/' + contentId,
					type: 'GET',
					dataType: 'json',
					beforeSend: function() {
						toggleLoader(true); // Show the loader before the request is sent
					},
					success: function(contentParts) {
						// Loop through the content parts and create an inputDiv for each one
						$.each(contentParts, function(index, contentPart) {
							var deleteIcon = $('<i class="fas fa-trash-alt delete-icon-in-edit"></i>');
							deleteIcon.attr('data-id', contentPart.id);		
							var inputDiv = $('<div class="form-group added-form-group" id="' + contentPart.id + '">');
							inputDiv.append('<h4>' + (index + 1) + ' . Bölüm</h4>');
							inputDiv.append(deleteIcon);
							inputDiv.append('<label for="namecontentInput">Masal Metni:</label>');
							inputDiv.append('<textarea class="form-control" id="namecontentInput" rows="5" style="height: 158px;">' + contentPart.text + '</textarea>');

							// Create a button for browsing image files
							var imageButton = $('<button type="button" class="btn btn-primary btn-sm ml-2 mt-2 mb-2"></button>');
							var iconSpan = $('<span class="mr-2"></span>'); // Create a new span element to hold the icon
							var imageIcon = $('<i class="fas fa-image"></i>'); // Create the icon element
							iconSpan.append(imageIcon); // Append the icon element to the span
							imageButton.append(iconSpan); // Append the span to the button
							imageButton.append('Resim Seç'); // Add the text to the button
							var imageInput = $('<input type="file" accept="image/*" style="display: none;" />');
							// Generate a unique ID for the image input element
							var imageInputId = 'imageInput' + contentPart.id;
							imageInput.attr('id', imageInputId);

							// Create a button for browsing audio files
							var audioButton = $('<button type="button" class="btn btn-primary btn-sm ml-2 mt-2 mb-2"></button>');
							var iconSpan = $('<span class="mr-2"></span>'); // Create a new span element to hold the icon
							var audioIcon = $('<i class="fas fa-volume-up"></i>'); // Create the icon element
							iconSpan.append(audioIcon); // Append the icon element to the span
							audioButton.append(iconSpan); // Append the span to the button
							audioButton.append('Ses Seç'); // Add the text to the button
							var audioInput = $('<input type="file" accept="audio/mpeg" style="display: none;">');

							// Generate a unique ID for the image input element
							var audioInputId = 'audioInput' + contentPart.id;
							audioInput.attr('id', audioInputId);
								
							var fileNameSpan = $('<div>');
							var imagePreview = $('<div>');
							imagePreview.attr('id', 'image-preview-' + contentPart.id);
								
							var audioPreview = $('<div>');
							audioPreview.attr('id', 'audio-preview-' + contentPart.id);
					
							// Append the button and input elements to the div
							inputDiv.append('<label for="imageInput'+contentPart.id+'">Kullanılacak İmaj Dosyası:</label>');
							inputDiv.append(imageButton);
							inputDiv.append(imageInput);
							inputDiv.append(fileNameSpan);					  
							
							if (contentPart.imagePath) {
								var imageXhr = new XMLHttpRequest();
								imageXhr.open('GET', 'http://16.171.13.68:8080/content-part/content-part/' + contentPart.id + '/image', true);
								imageXhr.responseType = 'blob';
								imageXhr.onload = function() {
									var imageUrl = URL.createObjectURL(imageXhr.response);
									var imageElement = document.createElement('img');
									imageElement.src = imageUrl;
									imageElement.classList.add('img-thumbnail');
									imageElement.setAttribute('data-original-src', contentPart.imagePath);
									imagePreview.append(imageElement); // Append to imagePreview variable
								};
								imageXhr.onerror = function() {
									console.error('Error getting image:', imageXhr.statusText);
								};
								imageXhr.send();
							} else {
								imagePreview.append('<img class="img-thumbnail">')
							}
							inputDiv.append(imagePreview); // Append the imagePreview variable here

							// Append the button and input elements to the div
							inputDiv.append('<label for="audioInput'+contentPart.id+'">Kullanılacak Ses Dosyası:</label>');
							inputDiv.append(audioButton);
							inputDiv.append(audioInput);
							inputDiv.append(audioPreview);

							if (contentPart.audioPath) {
								var audioXhr = new XMLHttpRequest();
								audioXhr.open('GET', 'http://16.171.13.68:8080/content-part/content-part/' + contentPart.id + '/audio', true);
								audioXhr.responseType = 'blob';
								audioXhr.onload = function() {
									if (audioXhr.status === 200) {
										var blob = new Blob([audioXhr.response], {type: 'audio/mpeg'});
										var audioUrl = URL.createObjectURL(blob);
										var audioElement = document.createElement('audio');
										audioElement.setAttribute('controls', '');
										audioElement.setAttribute('src', audioUrl);
										audioElement.classList.add('audio-thumbnail');
										audioElement.setAttribute('data-original-src', contentPart.audioPath);
										audioPreview.append(audioElement); // Append to audioPreview variable
									}
								};
								audioXhr.send();
							}else {
								audioPreview.append('<audio class="audio-thumbnail">')
							}

							// Append the new div to the input container
							$('#input-container').append(inputDiv);

							// Add event listener to the button to trigger the file input dialog
							imageButton.click(function() {
								imageInput.trigger('click');
							});
							imageInput.change(function() {
								var file = imageInput[0].files[0];
								$('#' + imageInputId + '-text').val(file.name);
								var reader = new FileReader();
								reader.onload = function(e) {
									// Use the result of the FileReader to display the selected image
									// You can replace the following line with your own image rendering logic
									$('#' + imageInputId + '-preview').attr('src', e.target.result);
									$('#image-preview-' + contentPart.id + ' .img-thumbnail').attr('src', e.target.result);
								}
								reader.readAsDataURL(file);
							});
							
							// Add event listener to the button to trigger the file input dialog
							audioButton.click(function() {
								audioInput.trigger('click');
							});
							audioInput.change(function() {
								var file = audioInput[0].files[0];
								var audioUrl = URL.createObjectURL(file);
								var audioElement = $('<audio controls>');
								var audioSource = $('<source type="audio/mpeg">');
								audioSource.attr('src', audioUrl);
								audioElement.append(audioSource);
								audioPreview.empty().append(audioElement); // Replace the existing audio preview with the new one
							});
						});

						// Show the modal
						$('#myModal').modal('show');

						// Add a click event listener to the save button
						$('#saveButton').off('click').on('click', function() {

							// Get the updated values from the input fields
							var name = $('#nameInput').val();
							var type = $('#typeInput').val();
							$.ajax({
								url: 'http://16.171.13.68:8080/content/'+ content.id,
								beforeSend: function() {
									toggleLoader(true); // Show the loader before the request is sent
								},
								type: 'PUT',
								dataType: 'json',
								contentType: 'application/json',
								data: JSON.stringify({
									subThemeId: subthemeID,
									name: name,
									type: type
								}),
								beforeSend: function() {
									toggleLoader(true); // Show the loader before the request is sent
								},
								contentType: 'application/json',
								success: function(updatedContent) {
									console.log('Content updated successfully:', updatedContent);

									// Close the modal
									$('#myModal').modal('hide');

									delay(function() {
										getContentBySubtheme(subthemeID);
									});
								},
								error: function(xhr, textStatus, errorThrown) {
									console.log('Error updating content:', textStatus);
								},
								complete: function() {
									toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
								}
							});

							var contentParts = [];
							
							$('.added-form-group').each(function(index) {
								var text = $(this).find('#namecontentInput').val();
								var contentPartId = $(this).closest('.added-form-group').attr('id');
								var imagePath = $(this).find('#imageInput'+contentPartId).val();
								if (!imagePath || imagePath == "") {
									imagePath = $(this).find('.img-thumbnail').data('original-src');
								}
								var audioPath = $(this).find('#audioInput'+contentPartId).val();
								if (!audioPath || audioPath == "") {
									audioPath = $(this).find('.audio-thumbnail').data('original-src');
								}

								var contentPart = {
									text: text,
									imagePath: imagePath,
									audioPath: audioPath,
									contentId: contentId,
									id: contentPartId
								};
								contentParts.push(contentPart);
							});

							// Make an AJAX request to update the content data
							$.ajax({
								url: 'http://16.171.13.68:8080/content-part/batch/',
								beforeSend: function() {
									toggleLoader(true); // Show the loader before the request is sent
								},
								type: 'PUT',
								dataType: 'json',
								contentType: 'application/json',
								data: JSON.stringify(contentParts),
								beforeSend: function() {
									toggleLoader(true); // Show the loader before the request is sent
								},
								contentType: 'application/json',
								success: function(updatedContent) {
									console.log('Content updated successfully:', updatedContent);

									// Close the modal
									$('#myModal').modal('hide');

									// Refresh the content table
									getContentBySubtheme(subthemeID);

									for (var i = 0; i < updatedContent.length; i++) {
										var imageEl = $('#image-preview-' + updatedContent[i].id);
										var imgEl = imageEl.find('img');
										var src = imgEl.attr('src');
										var audioEl = $('#audio-preview-' + updatedContent[i].id);								 
										var auEl = audioEl.find('source');
										var auElnochange = audioEl.find('audio');
										var audiosrc = auEl.attr('src');
										var audiosrcnochange = auElnochange.attr('src');

										if (src && src.includes('blob')) {
											console.log('Doesnt send a Delete and Post Requests');
										} else {
											if (updatedContent[i]) { // check if updatedContent[i] is defined
												if (updatedContent[i].imagePath) {
													var deleteUrl = 'http://16.171.13.68:8080/content-part/content-part/' + updatedContent[i].id + '/image?type=1';
													$.ajax({
														url: deleteUrl,
														type: 'DELETE',
														success: function() {
															console.log('Image deleted successfully for content part:', updatedContent[i]);
														},
														error: function(xhr, textStatus, errorThrown) {
															console.error('Error deleting image for content part:', updatedContent[i]);
														}
													});
												}
	
												$('.added-form-group').eq(i).each(function() {
													var contentPart = updatedContent[i];  
													var imageInputId = $(this).find('input[type=file][accept="image/*"]').attr('id');
													if (contentPart.imagePath) {
														var formData = new FormData();
														var formGroup = $(this);
														console.log(formGroup);
														var fileInput = formGroup.find('#' + imageInputId)[0];
														if (fileInput.files && fileInput.files[0]) {
															formData.append('file', fileInput.files[0]);
														}
														$.ajax({
															url: 'http://16.171.13.68:8080/content-part/upload/image?id=' + contentPart.id,
															type: 'POST',
															data: formData,
															contentType: false,
															processData: false,
															success: function(result) {
																console.log('Image uploaded successfully for content part:', contentPart);
															},
															error: function(xhr, textStatus, errorThrown) {
																console.error('Error uploading image for content part:', contentPart);
															}
														});
													}
												});
											}
										}
										if (audiosrcnochange) {
											console.log('Doesnt send a Delete and Post Requests');
										} else {
											if (updatedContent[i]) { // check if updatedContent[i] is defined
												if (updatedContent[i].audioPath) {
													var deleteUrl = 'http://16.171.13.68:8080/content-part/content-part/' + updatedContent[i].id + '/image?type=2';
													$.ajax({
														url: deleteUrl,
														type: 'DELETE',
														success: function() {
															console.log('Audio deleted successfully for content part:', updatedContent[i]);
														},
														error: function(xhr, textStatus, errorThrown) {
															console.error('Error deleting audio for content part:', updatedContent[i]);
														}
													});
												}

												$('.added-form-group').eq(i).each(function() {
													var contentPart = updatedContent[i];  
													var audioInputId = $(this).find('input[type=file][accept="audio/mpeg"]').attr('id');												 
													if (contentPart.audioPath) {
														var formData = new FormData();
														var formGroup = $(this);
														console.log(formGroup);
														var fileInput = formGroup.find('#' + audioInputId)[0];
														if (fileInput.files && fileInput.files[0]) {
															formData.append('file', fileInput.files[0]);
														}
														$.ajax({
															url: 'http://16.171.13.68:8080/content-part/upload/audio?id=' + contentPart.id,
															type: 'POST',
															data: formData,
															contentType: false,
															processData: false,
															success: function(result) {
																console.log('Audio uploaded successfully for content part:', contentPart);
															},
															error: function(xhr, textStatus, errorThrown) {
																console.error('Error uploading image for content part:', contentPart);
															}
														});										
													}	  
												});
											}
										}
									}
	
								},
								error: function(xhr, textStatus, errorThrown) {
									console.log('Error updating content:', textStatus);
								},
								complete: function() {
									toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
								}
							});
						});
					},
					error: function(xhr, textStatus, errorThrown) {
						console.log('Error loading content:', textStatus);
					},
					complete: function() {
						toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
					}
				});
			}
	  });
	});
		
	$(document).on('click', '.delete-button', function() {
		// Get the selected content ID
		var contentId = $('input[name="content-radio"]:checked').val();

		$.ajax({
			url: "http://16.171.13.68:8080/content/" + contentId,
			beforeSend: function() {
				toggleLoader(true); // Show the loader before the request is sent
			},
			type: "DELETE",
			success: function(response) {
				console.log("Theme deleted successfully:", response);
				$('input[name="content-radio"]:checked').closest("tr").remove();
				var radioGroup = $('input[name="content-radio"]');
				if (radioGroup.is(':checked')) {
					// At least one button is checked
					// Enable the edit button
					$('.edit-button').prop('disabled', false);
					$('.delete-button').prop('disabled', false);
				} else {
					// No buttons are checked
					// Disable the edit button
					$('.edit-button').prop('disabled', true);
					$('.delete-button').prop('disabled', true);
				}
			},
			error: function(xhr, textStatus, errorThrown) {
				console.log("Error deleting theme:", textStatus);
			},
			complete: function() {
				toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
			}
		});
	});
	
	$(document).on('click', '.add-button', function() {
			
		$('#input-container').empty();
		$('.first-modai-footer').empty();
		$('#input-container').append('<div class="form-group none-remove-group">'+
											'<label for="nameInput">Masal Adı:</label>'+
											'<input type="text" class="form-control" id="nameInput">'+
											'</div>'+
											'<div class="form-group none-remove-group">'+
											'<label for="typeInput">Yaş Aralığı:</label>'+
											'<select class="form-control" id="typeInput">'+
											'<option value="0">3-5 Yaş Aralığı</option>'+
											'<option value="1">6-8 Yaş Aralığı</option>'+
											'<option value="2">9-12 Yaş Aralığı</option>'+
											'</div>'+
											'</select>')		
												
		$('.first-modai-footer').append('<button type="button" class="btn btn-primary" id="addContentButton">Bölüm Ekle</button>'+
										'<button type="button" class="btn btn-danger" id="deleteContentButton">Bölüm Sil</button>')		

			
	  // Clear the input fields
	  $('#nameInput').val('');
	  $('#typeInput').val('0');
	  var subthemeId = $(this).attr('id');  	  
	  
	  // Show the modal
	  $('#myModal').modal('show');
	  
	  // Add a click event listener to the save button
	  $('#saveButton').off('click').on('click', function() {
	  
		// Get the updated values from the input fields
		var name = $('#nameInput').val();
		var type = $('#typeInput').val();

		// Get the subtheme ID from the button ID
		
		// Add the content item
		addContentItem(subthemeId, name, type);
 
		// Hide the modal

	  });
	});
	
	$(document).on('click', '#addContentButtoninEdit', function() {
		var headerCounter = $('#input-container .added-form-group').length + 1;
		var contentFindFromUpDiv = $('.form-group.none-remove-group:first').attr('contentid-value');
		var contentParts = [];
		var contentPart = {
			text: "",
			imagePath: "",
			audioPath: "",
			contentId: contentFindFromUpDiv
		};
		contentParts.push(contentPart);

		$.ajax({
			type: 'POST',
			url: 'http://16.171.13.68:8080/content-part/batch',
			data: JSON.stringify(contentParts),
			contentType: 'application/json',
			success: function(response) {

				console.log('Content part saved successfully!');
				var contentId = response[0].id;
				var deleteIcon = $('<i class="fas fa-trash-alt delete-icon-in-edit"></i>');
				deleteIcon.attr('data-id', response[0].id);

				var inputDiv = $('<div class="form-group added-form-group">');
				inputDiv.append('<h4>' + headerCounter + ' . Bölüm</h4>');
				inputDiv.append(deleteIcon);
				inputDiv.append('<label for="namecontentInput">Masal Metni:</label>');
				inputDiv.append('<textarea class="form-control" id="namecontentInput" rows="5" style="height: 158px;"></textarea>');
				
				// Create a button for browsing image files
				var imageButton = $('<button type="button" class="btn btn-primary btn-sm ml-2 mt-2 mb-2"></button>');
				var iconSpan = $('<span class="mr-2"></span>'); // Create a new span element to hold the icon
				var imageIcon = $('<i class="fas fa-image"></i>'); // Create the icon element
				iconSpan.append(imageIcon); // Append the icon element to the span
				imageButton.append(iconSpan); // Append the span to the button
				imageButton.append('Resim Seç'); // Add the text to the button
				var imageInput = $('<input type="file" accept="image/*" style="display: none;" />');

				// Generate a unique ID for the image input element
				var imageInputId = 'imageInput' + response[0].id;
				imageInput.attr('id', imageInputId);

				// Add event listener to the button to trigger the file input dialog
				imageButton.click(function() {
				  imageInput.trigger('click');
				});

				// Add event listener to the file input to update the input field value
				imageInput.change(function() {
				  var file = imageInput[0].files[0];
				  $('#' + imageInputId + '-text').val(file.name);
				  var reader = new FileReader();
				  reader.onload = function(e) {
					// Use the result of the FileReader to display the selected image
					// You can replace the following line with your own image rendering logic
					$('#' + imageInputId + '-preview').attr('src', e.target.result);
				  }
				  reader.readAsDataURL(file);
				});
				
				// Create an audio preview element
				var audioPreview = $('<audio controls>');
				var audioSource = $('<source type="audio/mpeg">');
				audioPreview.append(audioSource);

				var audioButton = $('<button type="button" class="btn btn-primary btn-sm ml-2 mt-2 mb-2"></button>');
				var iconSpan = $('<span class="mr-2"></span>'); // Create a new span element to hold the icon
				var audioIcon = $('<i class="fas fa-volume-up"></i>'); // Create the icon element
				iconSpan.append(audioIcon); // Append the icon element to the span
				audioButton.append(iconSpan); // Append the span to the button
				audioButton.append('Ses Seç'); // Add the text to the button
					
				var audioInput = $('<input type="file" accept="audio/mpeg" style="display: none;">');
				// Generate a unique ID for the image input element
				var audioInputId = 'audioInput' + response[0].id;
				audioInput.attr('id', audioInputId);

				// Add event listener to the button to trigger the file input dialog
				audioButton.click(function() {
					audioInput.trigger('click');
				});

				// Add event listener to the file input to update the audio source
				audioInput.change(function() {
					var file = audioInput[0].files[0];
					audioSource.attr('src', URL.createObjectURL(file));
					audioPreview[0].load();
					audioPreview[0].play();
				});

				// Append the button and input elements to the div
				inputDiv.append('<label for="' + imageInputId + '">Kullanılacak İmaj Dosyası:</label>');
				inputDiv.append(imageButton);
				inputDiv.append(imageInput);
				inputDiv.append('<input type="text" class="form-control" id="' + imageInputId + '-text" value="">');
				inputDiv.append('<img src="" id="' + imageInputId + '-preview" style="max-width: 100%;">');

				// Append the new button and input elements for the audio file				
				inputDiv.append('<label for="' + audioInputId + '">Kullanılacak Ses Dosyası:</label>');
				inputDiv.append(audioButton);
				inputDiv.append(audioInput);
				inputDiv.append(audioPreview);

				// Append the new div to the input container
				$('#input-container').append(inputDiv);
				$('.form-group.added-form-group').last().attr('id', contentId)

				$('#myModal').modal('show');
			},
			error: function(error) {
				console.error('Error saving content parts:', error);
			}
		});
	});

	$(document).on('click', '#addContentButton', function() {
		var headerCounter = $('#input-container .added-form-group').length + 1;
		// Create a new div containing the input elements
		var inputDiv = $('<div class="form-group added-form-group">');
		inputDiv.append('<h4>' + headerCounter + ' . Bölüm</h4>');
		inputDiv.append('<label for="namecontentInput">Masal Metni:</label>');
		inputDiv.append('<textarea class="form-control" id="namecontentInput" rows="5" style="height: 158px;"></textarea>');
		// Create a button for browsing image files
		var imageButton = $('<button type="button" class="btn btn-primary btn-sm ml-2 mt-2 mb-2"></button>');
		var iconSpan = $('<span class="mr-2"></span>'); // Create a new span element to hold the icon
		var imageIcon = $('<i class="fas fa-image"></i>'); // Create the icon element
		iconSpan.append(imageIcon); // Append the icon element to the span
		imageButton.append(iconSpan); // Append the span to the button
		imageButton.append('Resim Seç'); // Add the text to the button
		var imageInput = $('<input type="file" accept="image/*" style="display: none;" />');

		// Generate a unique ID for the image input element
		var imageInputId = 'imageInput' + headerCounter;
		imageInput.attr('id', imageInputId);

		// Add event listener to the button to trigger the file input dialog
		imageButton.click(function() {
		  imageInput.trigger('click');
		});

		// Add event listener to the file input to update the input field value
		imageInput.change(function() {
			var file = imageInput[0].files[0];
			$('#' + imageInputId + '-text').val(file.name);
			var reader = new FileReader();
			reader.onload = function(e) {
				// Use the result of the FileReader to display the selected image
				// You can replace the following line with your own image rendering logic
				$('#' + imageInputId + '-preview').attr('src', e.target.result);
			}
			reader.readAsDataURL(file);
		});

		// Create an audio preview element
		var audioPreview = $('<audio controls>');
		var audioSource = $('<source type="audio/mpeg">');
		audioPreview.append(audioSource);
		
		var audioButton = $('<button type="button" class="btn btn-primary btn-sm ml-2 mt-2 mb-2"></button>');
		var iconSpan = $('<span class="mr-2"></span>'); // Create a new span element to hold the icon
		var audioIcon = $('<i class="fas fa-volume-up"></i>'); // Create the icon element
		iconSpan.append(audioIcon); // Append the icon element to the span
		audioButton.append(iconSpan); // Append the span to the button
		audioButton.append('Ses Seç'); // Add the text to the button
				
		var audioInput = $('<input type="file" accept="audio/mpeg" style="display: none;">');
		// Generate a unique ID for the image input element
		var audioInputId = 'audioInput' + headerCounter;
		audioInput.attr('id', audioInputId);

		// Add event listener to the button to trigger the file input dialog
		audioButton.click(function() {
			audioInput.trigger('click');
		});

		var audioInput = $('<input type="file" accept="audio/mpeg" style="display: none;">');
		// Generate a unique ID for the audio input element
		var audioInputId = 'audioInput' + headerCounter;
		audioInput.attr('id', audioInputId);

		// Add event listener to the file input to update the audio source
		audioInput.change(function() {
			var file = audioInput[0].files[0];
			audioSource.attr('src', URL.createObjectURL(file));
			audioPreview[0].load();
			audioPreview[0].play();
		});

		// Append the button and input elements to the div
		inputDiv.append('<label for="' + imageInputId + '">Kullanılacak İmaj Dosyası:</label>');
		inputDiv.append(imageButton);
		inputDiv.append(imageInput);
		inputDiv.append('<input type="text" class="form-control" id="' + imageInputId + '-text" value="">');
		inputDiv.append('<img src="" id="' + imageInputId + '-preview" style="max-width: 100%;">');

		
		inputDiv.append('<label for="' + audioInputId + '">Kullanılacak Ses Dosyası:</label>');
		inputDiv.append(audioButton);
		inputDiv.append(audioInput);
		inputDiv.append(audioPreview);

		// Append the new div to the input container
		$('#input-container').append(inputDiv);
		$('#myModal').modal('show');
	});
	
	$(document).on('click', '#saveContentButton', function() {
	
	  // Get the content ID from the custom data attribute
	  var contentId = $(this).data('content-id');
	  
	  // Create an array to store the content parts
	  var contentParts = [];

	  // Loop through each form group and create a content part object
	  $('.added-form-group').each(function(index) {

		var text = $(this).find('#namecontentInput').val();
		var imagePath = $(this).find('#imageInput').val();
		var audioPath = $(this).find('#audioInput').val();
		
		// Create the content part object
		var contentPart = {
		  text: text,
		  imagePath: imagePath,
		  audioPath: audioPath,
		  contentId: contentId
		};
		
		// Add the content part to the array
		contentParts.push(contentPart);
	  });

	  // Make an AJAX request to save the content parts
	  $.ajax({
		url: 'http://16.171.13.68:8080/content-part',
		type: 'POST',
		dataType: 'json',
		contentType: 'application/json',
		data: JSON.stringify(contentParts),
		beforeSend: function() {
		  toggleLoader(true); // Show the loader before the request is sent
		},
		success: function(response) {
		  console.log('Content parts saved successfully:', response);
		  // Close the modal
		  $('#myModal').modal('hide');
		  // Refresh the content table
		  delay(function() {
			getContentBySubtheme(subthemeID);
		  });
		},
		error: function(xhr, textStatus, errorThrown) {
		  console.log('Error saving content parts:', textStatus);
		},
		complete: function() {
		  toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
		}
	  });
	});

	$(document).on('click', '#deleteContentButton', function() {
		  var lastInputGroup = $('#input-container .form-group:last-child');
		  if (!lastInputGroup.hasClass('none-remove-group')) {
			lastInputGroup.remove();
		  }
		  $('#myModal').modal('show');
		});
	
	$(document).on('click', '.delete-icon-in-edit', function() {
		// Get all added-form-group elements from the input container	  
	      var contentPartId = $(this).data('id');	 
		 if(contentPartId != ""){
			$.ajax({
			  url: 'http://16.171.13.68:8080/content-part/' + contentPartId,
			  type: 'DELETE',
			  success: function(result) {
				console.log('Content part deleted successfully:', result);
				$('.edit-button').click();
			  },
			  error: function(xhr, textStatus, errorThrown) {
				console.log('Error deleting content part:', textStatus);
			  }
			});
		 }
		 else {
		// If there is more than one added-form-group element or none, remove the last input group
		var lastInputGroup = $('#input-container .form-group:last-child');
		lastInputGroup.remove();
		  // Show the modal
		  $('#myModal').modal('show');
	  }
	});

	$(document).on('change', 'input[name="content-radio"]', function() {

		// Select the radio button group
		var radioGroup = $('input[name="content-radio"]');

		// Check if any of the buttons are checked
		if (radioGroup.is(':checked')) {
		  // At least one button is checked
		  // Enable the edit button
		  $('.edit-button').prop('disabled', false);
		  $('.delete-button').prop('disabled', false);
		} else {
		  // No buttons are checked
		  // Disable the edit button
		  $('.edit-button').prop('disabled', true);
		  $('.delete-button').prop('disabled', true);
		}
	});
  
	$('#my-button').click(function() {
		var themeName = prompt('Enter the name of the theme:');
		if (themeName) {
		  var data = { name: themeName };
		  $.ajax({
			url: 'http://16.171.13.68:8080/theme/',
			beforeSend: function() {
				toggleLoader(true); // Show the loader before the request is sent
			},
			type: 'POST',
			data: JSON.stringify(data),
			contentType: 'application/json',
			success: function(result) {
			  console.log('Theme added successfully:', result);
			  createThemeAccordionPanel(result);
			  $('#accordion').empty();
			  loadThemes();
			},
			error: function(xhr, textStatus, errorThrown) {
			  console.log('Error adding theme:', textStatus);
			},
			complete: function() {
				toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
			}
		  });

		}
	});
  
});

function editSubtheme(subthemeId) {
debugger
  var subtheme = {
    id: subthemeId,
    name: "",
    themeId: ""
  };
  
  // Retrieve the subtheme object using the id
  $.ajax({
    url: "http://16.171.13.68:8080/subtheme/" + subthemeId,
    type: "GET",
    dataType: "json",
    success: function(response) {
      subtheme.name = response.name;
      subtheme.themeId = response.themeId;
      
      // Prompt the user for a new name
      var subthemeName = prompt("Enter a new name for the subtheme:", subtheme.name);
      if (subthemeName !== null && subthemeName !== "") {
        var data = {
          "name": subthemeName,
          "themeId": subtheme.themeId
        };
        $.ajax({
          url: "http://16.171.13.68:8080/subtheme/" + subtheme.id,
          type: "PUT",
          data: JSON.stringify(data),
          contentType: "application/json",
          success: function(response) {
            console.log("Subtheme updated successfully:", response);
            // Update the subtheme name in the UI
            var subthemeLink = $("#collapse-" + subtheme.themeId).find("a").filter(function() {
              return $(this).text() === subtheme.name;
            });
            subthemeLink.text(subthemeName);
            subtheme.name = subthemeName;

            // Remove the existing icons from the link
            subthemeLink.children("i").remove();

			if (subthemeLink.children(".fas.fa-image").length === 0) {
              subthemeLink.append('<i class="fas fa-image mx-2 ml-auto" onclick="showsubthemeImage(' + subtheme.id + ')"></i>');
            }
			
			if (subthemeLink.children(".fas.fa-bars").length === 0) {
              subthemeLink.append('<i class="fas fa-bars mx-2" onclick="addSubthemeImage(' + subtheme.id + ')"></i>');
            }
			
            if (subthemeLink.children(".fas.fa-edit").length === 0) {
              subthemeLink.append('<i class="fas fa-edit mx-2" onclick="editSubtheme(' + subtheme.id + ')"></i>');
            }
            if (subthemeLink.children(".fas.fa-trash-alt").length === 0) {
              subthemeLink.append('<i class="fas fa-times mx-2" onclick="deleteSubtheme(' + subtheme.id + ')"></i>');
            }
          },
          error: function(xhr, textStatus, errorThrown) {
            console.log("Error updating subtheme:", textStatus);
          }
        });
      }
    },
    error: function(xhr, textStatus, errorThrown) {
      console.log("Error retrieving subtheme:", textStatus);
    }
  });
}


function addContentItem(subthemeId, name, type) {
	// Make an AJAX request to create the content item
	$.ajax({
		url: 'http://16.171.13.68:8080/content',
		type: 'POST',
		dataType: 'json',
		contentType: 'application/json',
		data: JSON.stringify({
		subThemeId: subthemeId,
		name: name,
		type: type
		}),
		beforeSend: function() {
			toggleLoader(true); // Show the loader before the request is sent
		},
		success: function(newContentItem) {
			console.log('Content item added successfully:', newContentItem);
			// Refresh the content table
			getContentBySubtheme(subthemeId);
			var contentParts = [];
			var headerCounter = 0;
			$('.added-form-group').each(function(index) {
				var text = $(this).find('#namecontentInput').val();
				var imageInputId = 'imageInput' + (index + 1); // Generate a unique ID for the imageInput element
				var imagePath = $(this).find('#' + imageInputId).val(); // Use the generated ID to select the imageInput element
				
				var audioInputId = 'audioInput' + (index + 1); // Generate a unique ID for the imageInput element
				var audioPath = $(this).find('#' + audioInputId).val(); // Use the generated ID to select the imageInput element				
				if (text || imagePath || audioPath) {
					var contentPart = {
					text: text,
					imagePath: imagePath,
					audioPath: audioPath,
					contentId: newContentItem.id
					};
					contentParts.push(contentPart);
				}
			});

			$.ajax({
				type: 'POST',
				url: 'http://16.171.13.68:8080/content-part/batch',
				data: JSON.stringify(contentParts),
				contentType: 'application/json',
				success: function(response) {
					console.log('Content parts saved successfully!');
					// Upload the selected image file for each content part
					$('.added-form-group').each(function(i) {
						var contentPart = contentParts[i];
						var imageInputId = $(this).find('input[type=file][accept="image/*"]').attr('id');
						var audioInputId = $(this).find('input[type=file][accept="audio/mpeg"]').attr('id');
						// Get the ID of the imageInput element
						if (contentPart.imagePath) {
							var formData = new FormData();
							var formGroup = $(this); // Store the reference to this element
							formData.append('file', formGroup.find('#' + imageInputId)[0].files[0]); // Use the stored reference to this element
							$.ajax({
								url: 'http://16.171.13.68:8080/content-part/upload/image?id=' + response[i].id,
								type: 'POST',
								data: formData,
								contentType: false,
								processData: false,
								success: function(result) {
									console.log('Image uploaded successfully for content part:', contentPart);
								},
								error: function(xhr, textStatus, errorThrown) {
									console.error('Error uploading image for content part:', contentPart);
								}
							});
						}
						if (contentPart.audioPath) {
							var formData = new FormData();
							var formGroup = $(this); // Store the reference to this element
							formData.append('file', formGroup.find('#' + audioInputId)[0].files[0]); // Use the stored reference to this element
							$.ajax({
								url: 'http://16.171.13.68:8080/content-part/upload/audio?id=' + response[i].id,
								type: 'POST',
								data: formData,
								contentType: false,
								processData: false,
								success: function(result) {
									console.log('Audio uploaded successfully for content part:', contentPart);
								},
								error: function(xhr, textStatus, errorThrown) {
									console.error('Error uploading image for content part:', contentPart);
								}
							});
						}


					});
				},
				error: function(error) {
					console.error('Error saving content parts:', error);
				}
			});
		},
		error: function(xhr, textStatus, errorThrown) {
		  console.log('Error adding content item:', textStatus);
		},
		complete: function() {
		  toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
		}
	});
	$('#myModal').modal('hide');
}

function loadThemes() {
	$.ajax({
		url: 'http://16.171.13.68:8080/theme',
		beforeSend: function() {
			toggleLoader(true); // Show the loader before the request is sent
		},
		type: 'GET',
		dataType: 'json',
		success: function(data) {
			$.each(data, function(index, theme) {
				createThemeAccordionPanel(theme);
			});
		},
		error: function(xhr, textStatus, errorThrown) {
			console.log('Error loading themes: ' + textStatus);
		},
		complete: function() {
			toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
		}
	});
}

function createThemeAccordionPanel(theme) {
	var panel = $("<div>", {
		"class": "card"
	}).appendTo("#accordion");

	var header = $("<div>", {
		"class": "card-header d-flex justify-content-between align-items-center",
		"id": "heading-" + theme.id
	}).appendTo(panel);

	$("<i>", {
		"id": "theme-image-"+ theme.id,
		"class": "fas fa-image mr-2 theme-image-preview",
		"click": function() {
			addThemeImage(theme.id);
		}	
	}).appendTo(header);

	var nameButton = $("<button>", {
		"class": "btn btn-link",
		"data-toggle": "collapse",
		"data-target": "#collapse-" + theme.id,
		"aria-expanded": "false",
		"aria-controls": "collapse-" + theme.id,
		"text": theme.name
	}).appendTo(header);

	header.click(function() {
		var collapse = $("#collapse-" + theme.id);
		if (collapse.children().length == 0) {
			collapse = createSubthemeCollapse(theme, {"id": theme.id}); // Call createSubthemeCollapse and assign its return value to collapse
			loadSubthemes(theme, collapse); // Pass collapse as an argument to loadSubthemes function
		}
	});

	$("<i>", {
		"class": "fas fa-plus ml-auto",
		"click": function() {
			addSubtheme(theme);
		}
	}).appendTo(header);

	$("<i>", {
		"class": "fas fa-edit ml-2",
		"click": function() {
			editTheme(theme);
		}
	}).appendTo(header);

	$("<i>", {
		"class": "fas fa-times ml-2",
		"click": function() {
			deleteTheme(theme.id);
		}
	}).appendTo(header);

	$("<div>", {
		"id": "collapse-" + theme.id,
		"class": "collapse",
		"aria-labelledby": "heading-" + theme.id,
		"data-parent": "#accordion"
	}).appendTo(panel);

	$("<ul>", {
		"class": "list-group list-group-flush"
	}).appendTo("#collapse-" + theme.id);

	// load and display the subthemes under the theme name
	loadAndDisplaySubthemes(theme.id);
	
	var imageUrl;
	// Add a mouseenter event listener to the image icon element
	$("#theme-image-" + theme.id).on("mouseenter", function() {
		// Check if the image preview div already exists, and create it if it doesn't
		if ($("#image-preview").length == 0) {
			$("<div>", {
				"id": "image-preview",
				"class": "image-preview",
				"css": {
					"position": "fixed",
					"top": "50%",
					"left": "50%",
					"transform": "translate(-50%, -50%)",
					"z-index": 9999
				}
			}).appendTo("body");
		}
		if (imageUrl) {
		// Use cached image
			$("<img>", {
				"src": imageUrl,
				"class": "img-thumbnail theme-image-preview-container"
			}).appendTo($("#image-preview"));
		} else {
		// Load the image from the server and add it to the div element
		var imageXhr = new XMLHttpRequest();
			imageXhr.open('GET', 'http://16.171.13.68:8080/theme/theme/' + theme.id + '/image', true);
			imageXhr.responseType = 'blob';
			imageXhr.onload = function() {
				imageUrl = URL.createObjectURL(imageXhr.response);
				$("<img>", {
					"src": imageUrl,
					"class": "img-thumbnail theme-image-preview-container"
				}).appendTo($("#image-preview"));
			};
			imageXhr.onerror = function() {
				console.error('Error getting image:', imageXhr.statusText);
				$("<img>", {
					"src": "placeholder.png",
					"class": "img-thumbnail theme-image-preview-container"
				}).appendTo($("#image-preview"));
			};
		imageXhr.send();
		}
	});
	// Add a mouseleave event listener to the image icon element to remove the preview div
	$("#theme-image-" + theme.id).on("mouseleave", function() {
		$("#image-preview").remove();
	});
}

function deleteTheme(themeId) {
	var myDiv = $("#collapse-" + themeId);
	if (myDiv.find("a.list-group-item").length > 0) {
	  // The div has a child li element with class myClass
	  // Do something here
	} else {
	  $.ajax({
		url: "http://16.171.13.68:8080/theme/" + themeId,
		beforeSend: function() {
			toggleLoader(true); // Show the loader before the request is sent
		},
		type: "DELETE",
		success: function(response) {
		  console.log("Theme deleted successfully:", response);
		  $("#heading-" + themeId).closest(".card").remove();
		},
		error: function(xhr, textStatus, errorThrown) {
		  console.log("Error deleting theme:", textStatus);
		},
		complete: function() {
			toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
		}
	  });
	}
}

function addThemeImage(themeId) {
	var fileInput = $('<input type="file" accept="image/*">');
	fileInput.trigger('click');

	var deleteUrl = 'http://16.171.13.68:8080/theme/theme/' + themeId + '/image?type=1';
	$.ajax({
		url: deleteUrl,
		type: 'DELETE',
		success: function() {
			console.log('Image deleted successfully for content part:', themeId);
			  $('#accordion').empty();
			  loadThemes();
		},
		error: function(xhr, textStatus, errorThrown) {
			console.error('Error deleting image for content part:', themeId);
		}
	});
  
	fileInput.one('change', function() {
  
    var file = fileInput[0].files[0];

    var formData = new FormData();
    formData.append('file', file);

    $.ajax({
      url: 'http://16.171.13.68:8080/theme/upload/image?id=' + themeId,
      type: 'POST',
      data: formData,
      contentType: false,
      processData: false,
      success: function(result) {
        console.log('Image uploaded successfully for content part:', themeId);
      },
      error: function(xhr, textStatus, errorThrown) {
        console.error('Error uploading image for content part:', themeId);
      }
    });

    fileInput.off('change');
  });
}

function addSubthemeImage(themeId) {

	var fileInput = $('<input type="file" accept="image/*">');
	fileInput.trigger('click');

	var deleteUrl = 'http://16.171.13.68:8080/subtheme/subtheme/' + themeId + '/image?type=1';
	$.ajax({
		url: deleteUrl,
		type: 'DELETE',
		success: function() {
			console.log('Image deleted successfully for content part:', themeId);
			  $('#accordion').empty();
			  loadThemes();
		},
		error: function(xhr, textStatus, errorThrown) {
			console.error('Error deleting image for content part:', themeId);
		}
	});
  
	fileInput.one('change', function() {
  
    var file = fileInput[0].files[0];

    var formData = new FormData();
    formData.append('file', file);

    $.ajax({
      url: 'http://16.171.13.68:8080/subtheme/upload/image?id=' + themeId,
      type: 'POST',
      data: formData,
      contentType: false,
      processData: false,
      success: function(result) {
        console.log('Image uploaded successfully for content part:', themeId);
      },
      error: function(xhr, textStatus, errorThrown) {
        console.error('Error uploading image for content part:', themeId);
      }
    });

    fileInput.off('change');
  });
}

function editTheme(theme) {
  var themeName = prompt("Enter a new name for the theme:");
  if (themeName !== null && themeName !== "") {
    var data = {
      "name": themeName
    };
    $.ajax({
      url: "http://16.171.13.68:8080/theme/" + theme.id,
	  beforeSend: function() {
		  toggleLoader(true); // Show the loader before the request is sent
	  },
      type: "PUT",
      data: JSON.stringify(data),
      contentType: "application/json",
      success: function(response) {
        console.log("Theme updated successfully:", response);
        // Update the theme name in the UI
        $("#heading-" + theme.id).find(".btn-link").text(themeName);
      },
      error: function(xhr, textStatus, errorThrown) {
        console.log("Error updating theme:", textStatus);
      },
	   complete: function() {
		  toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
	   }
    });
  }
}

function loadAndDisplaySubthemes(themeId) {
  $.ajax({
    url: "http://16.171.13.68:8080/subtheme/theme/" + themeId,
    beforeSend: function() {
      toggleLoader(true); // Show the loader before the request is sent
    },
    type: 'GET',
    dataType: 'json',
    success: function(subthemes) {
      var subthemeList = $("#collapse-" + themeId).find("ul");
      for (var i = 0; i < subthemes.length; i++) {
        var subtheme = subthemes[i];
        if (subtheme.themeId === themeId) {
          $("<a>", {
            "id": subtheme.id,
            "class": "list-group-item list-group-item-action d-flex justify-content-between align-items-center",
            "text": subtheme.name,
            "href": "#",
            "onclick": "changeButtonId('" + subtheme.id + "')"
          }). append(
            $("<i>", {
              "id": "sub-theme-image-"+ subtheme.id,
              "class": "fas fa-image ml-auto mx-2 sub-theme-image-preview",
              "click": function() {
                showsubthemeImage(subtheme.id);
              } 
            })
			).append(
            $("<i>", {
              "class": "fas fa-bars mx-2",
              "click": function() {
                addSubthemeImage(subtheme.id);
              } 
            })
          ).append(
            $("<i>", {
              "id": "sub-theme-edit-"+ subtheme.id,
              "class": "fas fa-edit mx-2",
              "click": createEditHandler(subtheme)
            })
          ).append(
            $("<i>", {
              "id": "sub-theme-delete-"+ subtheme.id,
              "class": "fas fa-times mx-2",
              "click": function() {
                deleteSubtheme(subtheme);
              }
            })
          ).appendTo(subthemeList);
        }
      }
    },
    error: function(xhr, textStatus, errorThrown) {
      console.log('Error loading subthemes: ' + textStatus);
    },
    complete: function() {
      toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
    }
  });

  function createEditHandler(subtheme) {
    return function() {
      editSubtheme(subtheme.id);
    };
  }
}


function showsubthemeImage(subthemeId) {
  var imageUrl;
  // Create the modal
  var modal = $("<div>", {
    "id": "image-modal",
    "class": "modal",
    "tabindex": "-1",
    "role": "dialog",
    "aria-labelledby": "image-modal-label",
    "aria-hidden": "true"
  }).appendTo("body");
  var modalDialog = $("<div>", {
    "class": "modal-dialog",
    "role": "document"
  }).appendTo(modal);
  var modalContent = $("<div>", {
    "class": "modal-content"
  }).appendTo(modalDialog);
  var modalHeader = $("<div>", {
    "class": "modal-header"
  }).appendTo(modalContent);
  var modalTitle = $("<h5>", {
    "class": "modal-title",
    "id": "image-modal-label",
    "text": "Subtheme Image"
  }).appendTo(modalHeader);
  var modalCloseButton = $("<button>", {
    "type": "button",
    "class": "close",
    "data-dismiss": "modal",
    "aria-label": "Close"
  }).appendTo(modalHeader);
  $("<span>", {
    "aria-hidden": "true",
    "html": "&times;"
  }).appendTo(modalCloseButton);
  var modalBody = $("<div>", {
    "class": "modal-body"
  }).appendTo(modalContent);
  var modalFooter = $("<div>", {
    "class": "modal-footer"
  }).appendTo(modalContent);
  $("<button>", {
    "type": "button",
    "class": "btn btn-secondary",
    "data-dismiss": "modal",
    "text": "Kapat"
  }).appendTo(modalFooter);

  // Use cached image if it exists
  if (imageUrl) {
    $("<img>", {
      "src": imageUrl,
      "class": "img-thumbnail sub-theme-image-preview-container"
    }).appendTo(modalBody);
    modal.modal("show");
  } else {
    // Load the image from the server and add it to the modal
    var imageXhr = new XMLHttpRequest();
    imageXhr.open('GET', 'http://16.171.13.68:8080/subtheme/sub-theme/' + subthemeId + '/image', true);
    imageXhr.responseType = 'blob';
    imageXhr.onload = function() {
      imageUrl = URL.createObjectURL(imageXhr.response);
      $("<img>", {
        "src": imageUrl,
        "class": "img-thumbnail sub-theme-image-preview-container"
      }).appendTo(modalBody);
      modal.modal("show");
    };
    imageXhr.onerror = function() {
      console.error('Error getting image:', imageXhr.statusText);
      $("<p>", {
        "text": "Error getting image"
      }).appendTo(modalBody);
      modal.modal("show");
    };
    imageXhr.send();
  }
}

function addSubtheme(theme) {
  var subthemeName = prompt("Enter the name of the new subtheme:");
  if (subthemeName !== null && subthemeName !== "") {
    var data = {
      "name": subthemeName,
      "themeId": theme.id
    };
    $.ajax({
      url: "http://16.171.13.68:8080/subtheme",
	  beforeSend: function() {
		toggleLoader(true); // Show the loader before the request is sent
	  },
      type: "POST",
      data: JSON.stringify(data),
      contentType: "application/json",
      success: function(response) {
        console.log("Subtheme created successfully:", response);
        // Add the new subtheme to the UI
        var subthemeItem = $("<a>", {
							  "id": response.id,
							  "class": "list-group-item list-group-item-action d-flex justify-content-between align-items-center",
							  "text": subthemeName,
							  "href": "#",
						      "onclick": "changeButtonId('" + response.id + "')"
							  }). append(
								$("<i>", {
								  "id": "sub-theme-image-"+ response.id,
								  "class": "fas fa-image ml-auto mx-2 sub-theme-image-preview",
								  "click": function() {
									showsubthemeImage(response.id);
								  } 
								})
								).append(
								$("<i>", {
								  "class": "fas fa-bars mx-2",
								  "click": function() {
									addSubthemeImage(response.id);
								  } 
								})
							  ).append(
							  $("<i>", {
								"class": "fas fa-edit mx-2",
								"click": function() {
								  editSubtheme(response);
								}
							  })
							).append(
							  $("<i>", {
								"class": "fas fa-times mx-2",
								"click": function() {
								  deleteSubtheme(response);
								}
							  })
							);


        $("#collapse-" + theme.id + " ul").append(subthemeItem);
      },
      error: function(xhr, textStatus, errorThrown) {
        console.log("Error creating subtheme:", textStatus);
      },
		complete: function() {
			toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
		}
    });
  }
}

function createSubthemeCollapse(theme, subtheme) {
  var heading = $("#heading-" + theme.id);
  var collapse = heading.find("#collapse-" + subtheme.id);
  if (collapse.length === 0) {
    collapse = $("<div>", {
      "id": "collapse-" + subtheme.id,
      "class": "collapse",
      "data-parent": "#accordion"
    }).appendTo(heading);
    $("<ul>", {
      "class": "list-group list-group-flush"
    }).appendTo(collapse);
  }
  return collapse; // Return the jQuery object for the collapse panel
}

function displaySubthemes(theme, subthemes, collapse) {
  if (!subthemes) {
    // If subthemes are not provided, retrieve them from the server
    $.ajax({
      url: "http://16.171.13.68:8080/subtheme/" + theme.id,
      beforeSend: function() {
		toggleLoader(true); // Show the loader before the request is sent
	  },
      type: "GET",
      dataType: "json",
      success: function(subthemes) {
        // Call the function recursively with the retrieved subthemes
        displaySubthemes(theme, subthemes, collapse);
      },
      error: function(xhr, textStatus, errorThrown) {
        console.log("Error loading subthemes: " + textStatus);
      },
		complete: function() {
			toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
		}
    });
    return;
  }

  if (!collapse) {
    collapse = createSubthemeCollapse(theme, subthemes[0]);
  }

  // Add the subtheme buttons to the collapse element
  $.each(subthemes, function(index, subtheme) {
    if (subtheme.themeId === theme.id) { // Only create UI elements for subthemes that match the theme ID
      $("<button>", {
        "class": "btn btn-link subtheme-button",
        "text": subtheme.name,
        "click": function() {
          loadContentPreviews(subtheme);
        }
      }).appendTo(collapse.find("ul"));
    }
  });

  // Append the subtheme name to the collapse header
  var header = collapse.parent().find(".card-header");
  if (header.children(".subtheme-name").length === 0) {
    $("<span>", {
      "class": "subtheme-name ml-2",
      "text": subthemes[0].name,
    }).appendTo(header);
  }
}

function loadSubthemes(theme) {
  $.ajax({
    url: "http://16.171.13.68:8080/subtheme/theme/" + theme.id,
	beforeSend: function() {
		toggleLoader(true); // Show the loader before the request is sent
	},
    type: "GET",
    dataType: "json",
    success: function(subthemes) {
      displaySubthemes(theme, subthemes);
    },
    error: function(xhr, textStatus, errorThrown) {
      console.log("Error loading subthemes: " + textStatus);
    },
	complete: function() {
		toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
	}
  });
}

function deleteSubtheme(subtheme) {
var subthemes = [];
  if (typeof subtheme === 'object') {
    subthemeId = subtheme.id;
  } else if (typeof subtheme === 'number') {
    subthemeId = subtheme;
  } else {
    console.log('Invalid subtheme:', subtheme);
    return;
  }
  
  if ($('td input[type="radio"][name="content-radio"]').val() === "" || $('td input[type="radio"][name="content-radio"]').val() === undefined) {
  // Input value is empty, do something
  
  $.ajax({
    url: "http://16.171.13.68:8080/subtheme/" + subthemeId,
	beforeSend: function() {
		toggleLoader(true); // Show the loader before the request is sent
	},
    type: "DELETE",
    success: function(response) {
      console.log("Subtheme deleted successfully:", response);
      $("#collapse-" + subtheme.themeId).find("a").filter(function() {
        return $(this).text() === subtheme.name;
      }).remove();
      
      // Refresh the subtheme list
      var subthemeList = $("#collapse-" + subtheme.themeId).find("ul");
      subthemeList.empty();
	  if (typeof subtheme === 'number') {
		loadAndDisplaySubthemes(subthemeId);
	  }
	  else{
		loadAndDisplaySubthemes(subtheme.themeId);
	  }
      
      
      // Remove the subtheme from the subthemes array
      subthemes = subthemes.filter(function(item) {
        return item.id !== subthemeId;
      });
    },
    error: function(xhr, textStatus, errorThrown) {
      console.log("Error deleting subtheme:", textStatus);
    },
	complete: function() {
		toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
	}
  });
} else {
  // Input value is not empty
}

}

function changeButtonId(buttonId) {
  var button = $('.add-button');
      button.attr("id", buttonId);
	  if (button.attr('id')) {
      // If the element doesn't have an ID, disable it
      button.prop('disabled', false);
    } 
	getContentBySubtheme(buttonId);
}

function addContent(subThemeId, name, type) {
  $.ajax({
    url: 'http://16.171.13.68:8080/content',
	beforeSend: function() {
		toggleLoader(true); // Show the loader before the request is sent
	},
    method: 'POST',
    dataType: 'json',
    contentType: 'application/json',
    data: JSON.stringify({
      subThemeId: subThemeId,
      name: name,
      type: type
    }),
    success: function(response) {
      console.log(response);
      // Handle successful response here
    },
    error: function(jqXHR, textStatus, errorThrown) {
      console.log(jqXHR.responseText);
      // Handle error response here
    },
	complete: function() {
		toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
	}
  });
}

function getContentBySubtheme(subthemeId) {
	$('.table tbody').empty();
	$.ajax({
		url: 'http://16.171.13.68:8080/content/subtheme/'+subthemeId,
		beforeSend: function() {
			toggleLoader(true); // Show the loader before the request is sent
		},
	method: 'GET',
	dataType: 'json',
	success: function(response) {
	console.log(response);
	// Create the table header

	// Create the table rows
	var tableRows = '';
	$.each(response, function(index, content) {
	tableRows += '<tr><td><input type="radio" name="content-radio" value="' + content.id + '"></td><td>' + content.name + '</td><td>' + content.type + '</td></tr>';
	});

	// Combine the header and rows into a table
	var contentTable = '<table class="table"><thead><tr><th></th><th>Masal Adı</th><th>Yaş Aralığı</th></tr></thead>' + tableRows + '</table>';

	// Display the table on the page
	$('#content-table').html(contentTable);

	},
	error: function(jqXHR, textStatus, errorThrown) {
	console.log(jqXHR.responseText);
	// Handle error response here
	},
	complete: function() {
	toggleLoader(false); // Hide the loader after the request is complete (regardless of success or failure)
	}
	});
	// Select all checkboxes with the name 'content-checkbox'
}

  </script>

  </body>
</html>
